<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mood Tracker</title>
  <style>
    :root {
      --bg: #fff;
      --text: #222;
      --card: #f9f9f9;
      --accent: #ff69b4;
      --button: #ffe4ec;
      --hover: #ffb6c1;
      --selected: #ff4fa2;
      --border: #e0e0e0;
      --memory: #fff9c4;
    }

    body.dark {
      --bg: #121212;
      --text: #f5f5f5;
      --card: #1f1f1f;
      --accent: #e91e63;
      --button: #333;
      --hover: #444;
      --selected: #ff4081;
      --memory: #5d4037;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      padding: 20px;
      transition: all 0.3s;
    }

    .app {
      max-width: 700px;
      margin: 0 auto;
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    h1 {
      color: var(--accent);
      text-align: center;
      margin-bottom: 20px;
    }

    .top-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    select, button {
      padding: 10px 15px;
      border-radius: 12px;
      border: none;
      background: var(--button);
      color: var(--text);
      font-size: 1rem;
    }

    .moods {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin: 20px 0;
    }

    .mood-btn {
      font-size: 2rem;
      background: var(--button);
      border-radius: 50%;
      width: 70px;
      height: 70px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mood-btn.selected {
      background: var(--selected);
      color: white;
      transform: scale(1.1);
    }

    textarea {
      width: 100%;
      min-height: 100px;
      padding: 15px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      margin-top: 15px;
      resize: none;
    }

    .submit-btn {
      width: 100%;
      padding: 15px;
      margin-top: 15px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }

    .submit-btn:hover {
      background: var(--selected);
    }

    .tabs {
      display: flex;
      margin-bottom: 15px;
    }

    .tab-btn {
      flex: 1;
      padding: 12px;
      background: var(--button);
      border: none;
      cursor: pointer;
    }

    .tab-btn.active {
      background: var(--accent);
      color: white;
    }

    .history-section {
      margin-top: 20px;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .toggle-history {
      background: none;
      border: none;
      color: var(--accent);
      cursor: pointer;
    }

    .mood-entry {
      padding: 15px;
      background: var(--button);
      border-radius: 12px;
      margin-bottom: 10px;
      display: flex;
      gap: 15px;
    }

    .mood-emoji {
      font-size: 1.8rem;
    }

    .mood-details {
      flex: 1;
    }

    .mood-date {
      font-size: 0.8rem;
      opacity: 0.8;
      text-align: right;
    }

    .memory-badge {
      background: var(--memory);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      margin-left: 5px;
    }

    .message {
      text-align: center;
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
    }

    .error {
      background: rgba(255,0,0,0.1);
      color: #f44336;
    }

    .success {
      background: rgba(0,255,0,0.1);
      color: #4caf50;
    }

    @media (max-width: 600px) {
      .moods {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="card">
    <h1>How are you feeling today? üåà</h1>
    <div class="top-bar">
      <select id="userSelect">
        <option value="Prasann">Prasann</option>
        <option value="Kamakhya">Kamakhya</option>
      </select>
      <button id="darkModeToggle">üåô Dark Mode</button>
    </div>

    <div class="moods">
      <button class="mood-btn" data-mood="Happy">üòä</button>
      <button class="mood-btn" data-mood="Sad">üò¢</button>
      <button class="mood-btn" data-mood="Angry">üò†</button>
      <button class="mood-btn" data-mood="Loved">üòç</button>
      <button class="mood-btn" data-mood="Sick">ü§í</button>
      <button class="mood-btn" data-mood="Tired">ü•±</button>
    </div>

    <textarea id="feelingText" placeholder="What's on your mind?"></textarea>
    <button class="submit-btn" id="submitBtn">Send Mood üíå</button>
    <div id="message"></div>
  </div>

  <div class="card">
    <div class="tabs">
      <button class="tab-btn active" data-user="Kamakhya">Kamakhya</button>
      <button class="tab-btn" data-user="Prasann">Prasann</button>
    </div>

    <div id="KamakhyaTab" class="history-section">
      <div class="history-header">
        <h3>Today's Mood</h3>
        <button class="toggle-history" data-user="Kamakhya">‚ñº Show History</button>
      </div>
      <ul id="kamakhyaToday"></ul>
      <div id="kamakhyaHistory" style="display:none"></div>
      <div id="kamakhyaMemories"></div>
    </div>

    <div id="PrasannTab" class="history-section" style="display:none">
      <div class="history-header">
        <h3>Today's Mood</h3>
        <button class="toggle-history" data-user="Prasann">‚ñº Show History</button>
      </div>
      <ul id="prasannToday"></ul>
      <div id="prasannHistory" style="display:none"></div>
      <div id="prasannMemories"></div>
    </div>
  </div>
</div>

<script>
  // Configuration
  const API_BASE = 'https://mood-backend-rvf9.onrender.com/api';
  const MOOD_EMOJIS = {
    'Happy': 'üòä', 'Sad': 'üò¢', 'Angry': 'üò†',
    'Loved': 'üòç', 'Sick': 'ü§í', 'Tired': 'ü•±'
  };

  // DOM Elements
  const userSelect = document.getElementById('userSelect');
  const darkModeToggle = document.getElementById('darkModeToggle');
  const moodButtons = document.querySelectorAll('.mood-btn');
  const feelingText = document.getElementById('feelingText');
  const submitBtn = document.getElementById('submitBtn');
  const messageDiv = document.getElementById('message');
  const tabButtons = document.querySelectorAll('.tab-btn');
  const toggleHistoryBtns = document.querySelectorAll('.toggle-history');

  // State
  let selectedMood = null;
  let currentTab = 'Kamakhya';

  // Initialize
  function init() {
    loadDarkMode();
    setupEventListeners();
    loadData();
  }

  // Event Listeners
  function setupEventListeners() {
    // Mood selection
    moodButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        moodButtons.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedMood = btn.dataset.mood;
      });
    });

    // Form submission
    submitBtn.addEventListener('click', submitMood);

    // Tab switching
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        tabButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentTab = btn.dataset.user;
        
        document.getElementById('KamakhyaTab').style.display = 
          currentTab === 'Kamakhya' ? 'block' : 'none';
        document.getElementById('PrasannTab').style.display = 
          currentTab === 'Prasann' ? 'block' : 'none';
      });
    });

    // History toggle
    toggleHistoryBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        const user = this.dataset.user;
        const historyEl = document.getElementById(`${user}History`);
        
        if (historyEl.style.display === 'none') {
          historyEl.style.display = 'block';
          this.textContent = '‚ñ≤ Hide History';
        } else {
          historyEl.style.display = 'none';
          this.textContent = '‚ñº Show History';
        }
      });
    });

    // Dark mode toggle
    darkModeToggle.addEventListener('click', toggleDarkMode);
  }

  // Data Loading
  async function loadData() {
    await Promise.all([
      fetchTodayMoods('Kamakhya'),
      fetchTodayMoods('Prasann'),
      fetchMemories('Kamakhya'),
      fetchMemories('Prasann')
    ]);
  }

  // Fetch today's moods
  async function fetchTodayMoods(user) {
    try {
      const response = await fetch(`${API_BASE}/mood/today/${user}`);
      const moods = await response.json();
      
      const todayEl = document.getElementById(`${user}Today`);
      todayEl.innerHTML = moods.length 
        ? moods.map(mood => createMoodElement(mood, true)).join('')
        : '<li class="mood-entry">No moods today</li>';
    } catch (error) {
      console.error(`Error loading ${user}'s today moods:`, error);
    }
  }

  // Fetch full history (when expanded)
  async function fetchHistory(user) {
    try {
      const response = await fetch(`${API_BASE}/mood/${user}`);
      const moods = await response.json();
      
      // Auto-collapse entries older than 7 days
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      
      const historyEl = document.getElementById(`${user}History`);
      historyEl.innerHTML = moods
        .filter(mood => new Date(mood.timestamp) < sevenDaysAgo)
        .map(mood => createMoodElement(mood, false))
        .join('') || '<li class="mood-entry">No older moods</li>';
    } catch (error) {
      console.error(`Error loading ${user}'s history:`, error);
    }
  }

  // Fetch memories from last month
  async function fetchMemories(user) {
    try {
      const response = await fetch(`${API_BASE}/mood/memories/${user}`);
      const memories = await response.json();
      
      const memoriesEl = document.getElementById(`${user}Memories`);
      if (memories.length) {
        memoriesEl.innerHTML = `
          <div class="history-header">
            <h3>On this day last month</h3>
          </div>
          ${memories.map(mood => createMoodElement(mood, false, true)).join('')}
        `;
      } else {
        memoriesEl.innerHTML = '';
      }
    } catch (error) {
      console.error(`Error loading ${user}'s memories:`, error);
    }
  }

  // Submit new mood
  async function submitMood() {
    const user = userSelect.value;
    const feeling = feelingText.value.trim();
    
    if (!selectedMood && !feeling) {
      showMessage('Please select a mood or write something', 'error');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending...';
    
    try {
      const response = await fetch(`${API_BASE}/mood`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          user, 
          mood: selectedMood, 
          feeling: feeling || undefined 
        })
      });

      if (!response.ok) throw new Error('Failed to save mood');

      showMessage('‚úÖ Mood saved successfully!', 'success');
      
      // Reset form
      selectedMood = null;
      moodButtons.forEach(btn => btn.classList.remove('selected'));
      feelingText.value = '';
      
      // Refresh data
      await Promise.all([
        fetchTodayMoods(user),
        fetchMemories(user)
      ]);
    } catch (error) {
      console.error('Error submitting mood:', error);
      showMessage('‚ùå Failed to save mood', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Send Mood üíå';
    }
  }

  // Create mood element HTML
  function createMoodElement(mood, isToday, isMemory) {
    const date = new Date(mood.timestamp);
    const now = new Date();
    
    let dateString;
    if (isToday) {
      dateString = 'Today';
    } else if (date.toDateString() === now.toDateString()) {
      dateString = 'Today';
    } else if (date.getFullYear() === now.getFullYear()) {
      dateString = date.toLocaleDateString([], { month: 'short', day: 'numeric' });
    } else {
      dateString = date.toLocaleDateString([], { year: 'numeric', month: 'short', day: 'numeric' });
    }
    
    return `
      <li class="mood-entry" ${isMemory ? 'style="background:var(--memory)"' : ''}>
        <div class="mood-emoji">${MOOD_EMOJIS[mood.mood] || ''}</div>
        <div class="mood-details">
          <strong>${mood.mood}</strong>
          ${mood.feeling ? `<div>${mood.feeling}</div>` : ''}
        </div>
        <div class="mood-date">
          ${dateString}
          ${isMemory ? '<span class="memory-badge">Memory</span>' : ''}
          <div>${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        </div>
      </li>
    `;
  }

  // Dark mode toggle
  function toggleDarkMode() {
    document.body.classList.toggle('dark');
    const isDark = document.body.classList.contains('dark');
    localStorage.setItem('darkMode', isDark);
    darkModeToggle.textContent = isDark ? 'üåû Light Mode' : 'üåô Dark Mode';
  }

  function loadDarkMode() {
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark');
      darkModeToggle.textContent = 'üåû Light Mode';
    }
  }

  // Show message
  function showMessage(text, type) {
    messageDiv.textContent = text;
    messageDiv.className = `message ${type}`;
    
    if (type === 'success') {
      setTimeout(() => {
        messageDiv.textContent = '';
        messageDiv.className = 'message';
      }, 3000);
    }
  }

  // Initialize when history button is clicked
  document.querySelectorAll('.toggle-history').forEach(btn => {
    btn.addEventListener('click', function() {
      const user = this.dataset.user;
      const historyEl = document.getElementById(`${user}History`);
      
      if (historyEl.style.display === 'none' && historyEl.innerHTML === '') {
        fetchHistory(user);
      }
    });
  });

  // Start the app
  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
